{% extends "base.html" %}

{% block title %}Create {% endblock title %}


{% block script %}
<script>

function createPost(value, newPost){
  let post = "<div class='col s12 m8 offset-m2 l6 offset-l3'>" +
      "<div class='card-panel grey lighten-5 z-depth-1'>" +
          "<div class='row valign-wrapper'>"+
            "<div class='col s2'>"+
              "<img src='https://www.madisondodgeronline.com/wp-content/uploads/2016/09/IMG_9097.png' width = 70px' class='circle responsive-img'>"+
            "</div>"+
            "<div class='col s10'>"+
              "<h4>"+value.content+"</h4>"+
                "<span class='black-text'>"+
                value.user.username +" | " + value.time + `<a href="${value.view}"> View</a> ` +
                  ` <a href="${value.update}">Update</a> ` + ` <a href="${value.delete}"> Delete</a>` +

                "</span>"+
            "</div>"+
          "</div>"+
      "</div>"+
    "</div>"
    if (newPost == true){
      $('#posts').prepend(post)
    }else{
      $('#posts').append(post)
    }


}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

let query = getParameterByName('q');

var posts = [];
function populate(){
  $.each(posts, function(key, value){
    console.log(key);
    console.log(value.content);
    createPost(value);

  });

}

function getPosts(){
  $.ajax({
    url: "/api/mmsca2/",
    method: "GET",
    data: {
      'q': query
    },
    success: function(data){
      console.log(data);

      posts = data;
      populate();

    },error: function(data){
      console.log(`errord${data}`);
    },

  });

}

getPosts();

function clear(){
  console.log("clear");
  document.getElementById("id_content").innerHTML = "John";
}

let current = 0;
let start = 160;

$('#bottom').append("<span id='chars'>160</span>");

$('#postform textarea').keyup(function(event){
  console.log(event);
  let postVal = $(this).val();
  current = start - postVal.length;
  $('#chars').text(current);

})

$('#postform').submit(function(event){
  event.preventDefault();
  let data = $(this);
  console.log(data);
  let formData = data.serialize();

  if (current >= 0){
    console.log(event);
    $.ajax({
      url: "/api/mmsca2/create/",
      method: "POST",
      data: formData,
      success: function(data){
        console.log(data);
        createPost(data, true);
        clear();
      },error: function(data){
        console.log(`errord${data}`);
      },

    });

  }else{
    console.log('to long');
  }


});




</script>

{% endblock script %}

{% block content %}
{% if not request.GET.q %}
<div class="row">
  {% if user.is_authenticated %}
  <h1>Hi {{ user.username }}!</h1>
  {% include "mmsca2/form.html" with form=create_form form_id="postform" action_url="create"  btn_title='Post' %}
{% else %}
  <p>You are not logged in</p>
  <a href="{% url 'login' %}">login</a>
{% endif %}

</div>

{% endif %}

<div id='posts'>

</div>

{% endblock content %}
